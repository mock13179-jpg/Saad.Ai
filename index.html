<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>سعد.AI - الذكاء الاصطناعي المتطور</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- إزالة مكتبة Google Sign-In -->
  <style>
    /* أنماط عالمية بتصميم فاخر بالأسود */
    :root {
      --primary-black: #000000;
      --dark-charcoal: #121212;
      --graphite: #1a1a1a;
      --carbon: #222222;
      --light-charcoal: #2d2d2d;
      --platinum: #e0e0e0;
      --silver: #f0f0f0;
      --neon-blue: #4895ef;
      --electric-purple: #a855f7;
      --font-primary: 'Tajawal', 'Segoe UI', sans-serif;
      --gold-accent: #ffd700;
      
      /* متغيرات السمات */
      --theme-primary: #4895ef;
      --theme-secondary: #a855f7;
      --theme-background: #121212;
      --theme-surface: #1a1a1a;
      --theme-text: #f0f0f0;
      --theme-text-secondary: #e0e0e0;
    }

    /* سمة فاتحة */
    .theme-light {
      --primary-black: #ffffff;
      --dark-charcoal: #f5f5f5;
      --graphite: #e8e8e8;
      --carbon: #e0e0e0;
      --light-charcoal: #d5d5d5;
      --platinum: #333333;
      --silver: #222222;
      --neon-blue: #1a73e8;
      --electric-purple: #6200ee;
      --theme-primary: #1a73e8;
      --theme-secondary: #6200ee;
      --theme-background: #ffffff;
      --theme-surface: #f5f5f5;
      --theme-text: #222222;
      --theme-text-secondary: #333333;
    }

    /* سمة زرقاء */
    .theme-blue {
      --primary-black: #0a192f;
      --dark-charcoal: #112240;
      --graphite: #1d3a5f;
      --carbon: #264b7a;
      --light-charcoal: #2d5c94;
      --platinum: #ccd6f6;
      --silver: #a8b2d1;
      --neon-blue: #64ffda;
      --electric-purple: #57cbff;
      --theme-primary: #64ffda;
      --theme-secondary: #57cbff;
      --theme-background: #0a192f;
      --theme-surface: #112240;
      --theme-text: #ccd6f6;
      --theme-text-secondary: #a8b2d1;
    }

    /* سمة خضراء */
    .theme-green {
      --primary-black: #0d2618;
      --dark-charcoal: #1a3c27;
      --graphite: #275236;
      --carbon: #346845;
      --light-charcoal: #417e54;
      --platinum: #d4e6d9;
      --silver: #a8c5b1;
      --neon-blue: #4caf50;
      --electric-purple: #8bc34a;
      --theme-primary: #4caf50;
      --theme-secondary: #8bc34a;
      --theme-background: #0d2618;
      --theme-surface: #1a3c27;
      --theme-text: #d4e6d9;
      --theme-text-secondary: #a8c5b1;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }

    body {
      font-family: var(--font-primary);
      background: linear-gradient(135deg, var(--theme-background) 0%, var(--dark-charcoal) 100%);
      color: var(--theme-text);
      line-height: 1.8;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    body::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 10% 20%, rgba(var(--theme-primary-rgb), 0.05) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(var(--theme-secondary-rgb), 0.05) 0%, transparent 20%);
      pointer-events: none;
      z-index: -1;
    }

    /* تصميم متطور للحاوية الرئيسية */
    .app-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(var(--theme-surface-rgb), 0.9);
      box-shadow: 
        0 0 50px rgba(0, 0, 0, 0.8),
        0 0 100px rgba(var(--theme-primary-rgb), 0.1);
      border-left: 1px solid rgba(var(--theme-primary-rgb), 0.1);
      border-right: 1px solid rgba(var(--theme-primary-rgb), 0.1);
      position: relative;
      overflow: hidden;
    }

    /* شريط العنوان الفاخر */
    .app-header {
      background: linear-gradient(90deg, var(--primary-black) 0%, var(--graphite) 100%);
      color: var(--theme-text);
      padding: 1.5rem 3rem;
      text-align: center;
      border-bottom: 3px solid var(--theme-primary);
      position: relative;
      overflow: hidden;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .app-header::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--theme-primary), var(--theme-secondary));
      animation: headerGlow 3s infinite alternate;
    }

    @keyframes headerGlow {
      0% { opacity: 0.3; }
      100% { opacity: 1; }
    }

    /* تصميم الشعار */
    .logo-main {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      position: relative;
      z-index: 3;
      flex: 1;
    }

    .header-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .header-btn {
      background: none;
      border: none;
      color: var(--theme-text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 10px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .header-btn:hover {
      background: rgba(var(--theme-primary-rgb), 0.2);
      transform: scale(1.1);
    }

    /* زر تسجيل الدخول - تم التعديل لإزالة تسجيل الدخول */
    .login-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
      padding: 8px 16px;
      background: rgba(var(--theme-primary-rgb), 0.1);
      border: 1px solid rgba(var(--theme-primary-rgb), 0.3);
      border-radius: 20px;
      color: var(--theme-text);
    }

    .login-btn:hover {
      background: rgba(var(--theme-primary-rgb), 0.3);
    }

    .main-logo {
      width: 140px;
      height: 140px;
      object-fit: contain;
      border-radius: 50%;
      background: linear-gradient(145deg, var(--graphite), var(--primary-black));
      padding: 15px;
      box-shadow: 
        0 0 20px rgba(var(--theme-primary-rgb), 0.3),
        0 0 40px rgba(var(--theme-primary-rgb), 0.1);
      border: 2px solid var(--theme-primary);
      transition: transform 0.5s ease;
    }

    .main-logo:hover {
      transform: rotate(10deg) scale(1.05);
    }

    .logo-main h1 {
      font-size: 3rem;
      font-weight: 800;
      background: linear-gradient(90deg, var(--theme-primary), var(--theme-secondary));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 20px rgba(var(--theme-primary-rgb), 0.5);
      letter-spacing: 1px;
    }

    .subtitle {
      font-size: 1.2rem;
      opacity: 0.9;
      margin-top: 0.5rem;
      color: var(--theme-text-secondary);
      max-width: 600px;
      margin: 10px auto;
      line-height: 1.6;
      flex-basis: 100%;
    }

    /* منطقة الدردشة المتطورة */
    .chat-container {
      display: flex;
      flex-direction: column;
      flex: 1;
      padding: 2rem;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="none" stroke="rgba(var(--theme-primary-rgb), 0.1)" stroke-width="0.5"/></svg>');
      background-size: 30px 30px;
      position: relative;
    }

    .chat-history {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border-radius: 16px;
      background: rgba(var(--theme-surface-rgb), 0.7);
      border: 1px solid rgba(var(--theme-primary-rgb), 0.2);
      box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      gap: 12px; /* تقليل المسافة بين الرسائل */
    }

    .welcome-message {
      text-align: center;
      padding: 1.5rem;
      color: var(--theme-primary);
      font-weight: 600;
      font-size: 1.3rem;
      background: rgba(var(--theme-surface-rgb), 0.6);
      border-radius: 12px;
      border: 1px solid rgba(var(--theme-primary-rgb), 0.3);
      margin-bottom: 20px;
    }

    /* رسائل حديثة بتصميم عصري */
    .message {
      margin-bottom: 0.5rem;
      padding: 0.8rem; /* تقليل الحشو الداخلي */
      border-radius: 18px;
      max-width: 85%;
      position: relative;
      animation: fadeIn 0.4s ease;
      line-height: 1.7;
      font-size: 1.1rem;
      word-break: break-word;
      overflow-wrap: break-word;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow: hidden;
      border: none !important;
      min-width: 120px;
      box-sizing: border-box;
      background: rgba(255, 255, 255, 0.03) !important; /* خلفية موحدة خفيفة */
      box-shadow: none !important;
      backdrop-filter: none !important;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .user-message {
      background: rgba(255, 255, 255, 0.04) !important; /* فرق طفيف للتمييز */
      color: var(--theme-text);
      margin-left: auto;
      margin-right: 0;
      max-width: 90%;
      width: fit-content;
      padding-left: 1.8rem;
      padding-right: 1.2rem;
      border-radius: 18px 5px 18px 18px;
    }

    .bot-message {
      background: rgba(255, 255, 255, 0.03) !important; /* نفس لون المستخدم تقريباً */
      color: var(--theme-text-secondary);
      margin-right: auto;
      margin-left: 0;
      max-width: 90%;
      width: fit-content;
      padding-right: 1.8rem;
      padding-left: 1.2rem;
      border-radius: 5px 18px 18px 18px;
    }

    .message p {
      margin-bottom: 10px;
      word-break: break-word;
      overflow-wrap: anywhere;
      hyphens: auto;
      text-align: right;
      padding: 6px 10px; /* تقليل padding للنص */
      margin: 0; /* إزالة الهوامش */
    }

    .message-time {
      font-size: 0.8rem;
      opacity: 0.7;
      display: block;
      margin-top: 0.8rem;
      color: var(--theme-text-secondary);
      text-align: left;
      padding: 0 10px; /* إضافة padding للوقت */
    }

    /* أزرار الرسائل - تصميم جديد */
    .message-actions {
      display: flex;
      justify-content: flex-start;
      gap: 8px;
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      overflow-x: auto; /* للتمرير الأفقي على الشاشات الصغيرة */
      padding-bottom: 5px;
      min-height: 44px; /* ارتفاع مناسب للمس */
    }

    .message-actions::-webkit-scrollbar {
      height: 4px;
    }

    .message-actions::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
    }

    .message-actions::-webkit-scrollbar-thumb {
      background: rgba(var(--theme-primary-rgb), 0.5);
      border-radius: 2px;
    }

    .message-btn {
      background: transparent !important; /* خلفية شفافة */
      border: none !important;
      color: var(--theme-text-secondary) !important;
      width: 44px !important; /* حجم مناسب للمس */
      height: 44px !important;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px !important; /* حجم أيقونات أكبر */
      transition: all 0.2s ease;
      padding: 6px !important; /* padding داخلي صغير */
      min-width: 44px !important; /* عرض أدنى */
    }

    .message-btn:hover {
      background: rgba(255, 255, 255, 0.1) !important; /* تأثير hover خفيف */
      transform: scale(1.05);
    }

    .message-btn.active-like {
      color: #4CAF50 !important;
      background: rgba(76, 175, 80, 0.1) !important;
    }

    .message-btn.active-dislike {
      color: #f44336 !important;
      background: rgba(244, 67, 54, 0.1) !important;
    }

    /* منطقة الإدخال بتصميم فاخر */
    .input-area {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
      position: relative; /* للسماح بوضع زر الإرسال المطلق */
    }

    textarea {
      width: 100%;
      padding: 1.2rem 5rem 1.2rem 5.5rem; /* زيادة المساحة على اليمين لزر المرفق */
      border: 2px solid rgba(var(--theme-primary-rgb), 0.3);
      border-radius: 14px;
      resize: none;
      font-family: var(--font-primary);
      font-size: 1.1rem;
      background: rgba(var(--theme-surface-rgb), 0.7);
      color: var(--theme-text);
      backdrop-filter: blur(5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      min-height: 120px;
    }

    textarea:focus {
      outline: none;
      border-color: var(--theme-primary);
      box-shadow: 0 0 0 3px rgba(var(--theme-primary-rgb), 0.3), 0 0 20px rgba(var(--theme-primary-rgb), 0.2);
    }

    textarea::placeholder {
      color: #777;
    }

    /* زر المرفق الجديد */
    .attach-fab {
      position: absolute;
      left: 75px; /* وضع على يسار زر الإرسال */
      bottom: 12px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, var(--light-charcoal) 0%, var(--carbon) 100%);
      color: var(--theme-text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 10;
    }

    .attach-fab:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 6px 18px rgba(var(--theme-primary-rgb), 0.4);
      background: linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-secondary) 100%);
      color: white;
    }

    .attach-fab:active {
      transform: translateY(0) scale(0.98);
    }

    /* زر الإرسال الدائري */
    .send-fab {
      position: absolute;
      left: 12px;
      bottom: 12px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-secondary) 100%);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(var(--theme-primary-rgb), 0.4);
      z-index: 10;
    }

    .send-fab:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 6px 18px rgba(var(--theme-primary-rgb), 0.6);
    }

    .send-fab:active {
      transform: translateY(0) scale(0.98);
    }

    /* مجموعة الأزرار (تم إزالة النسخ والمسح) */
    .button-group {
      display: flex;
      gap: 1.2rem;
      justify-content: flex-end;
    }

    button {
      padding: 0.9rem 1.8rem;
      border: none;
      border-radius: 12px;
      font-family: var(--font-primary);
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.7rem;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      background: linear-gradient(135deg, var(--light-charcoal) 0%, var(--carbon) 100%);
      color: var(--theme-text);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    button::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transform: translateX(-100%);
    }

    button:hover::before {
      animation: shine 1.5s infinite;
    }

    @keyframes shine {
      100% { transform: translateX(100%); }
    }

    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
    }

    button:active {
      transform: translateY(1px);
    }

    .primary-btn {
      background: linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-secondary) 100%);
      color: white;
      border: 1px solid rgba(var(--theme-primary-rgb), 0.5);
    }

    .primary-btn:hover {
      background: linear-gradient(135deg, #3a7bd5 0%, #8a2be2 100%);
      box-shadow: 0 0 20px rgba(var(--theme-primary-rgb), 0.4);
    }

    .secondary-btn {
      background: linear-gradient(135deg, var(--graphite) 0%, var(--light-charcoal) 100%);
      color: var(--theme-text-secondary);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .secondary-btn:hover {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      border-color: rgba(var(--theme-primary-rgb), 0.3);
    }

    /* الشريط الجانبي المعدل */
    .sidebar {
      position: fixed;
      top: 0;
      right: -350px;
      width: 320px;
      height: 100vh;
      background: var(--dark-charcoal);
      border-left: 1px solid rgba(var(--theme-primary-rgb), 0.3);
      z-index: 1000;
      transition: right 0.3s ease;
      padding: 20px;
      overflow-y: auto;
      box-shadow: -5px 0 15px rgba(0, 0, 0, 0.5);
    }

    .sidebar.open {
      right: 0;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(var(--theme-primary-rgb), 0.3);
    }

    .sidebar-title {
      font-size: 1.3rem;
      color: var(--theme-primary);
    }

    /* تعديل: تحسين تصميم أزرار الشريط الجانبي */
    .sidebar-controls {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 15px; /* زيادة المسافة بين الأزرار */
    }

    .close-sidebar {
      background: none;
      border: none;
      color: var(--theme-text-secondary);
      font-size: 1.3rem; /* حجم مناسب لأيقونة الإغلاق */
      cursor: pointer;
      padding: 10px;
      border-radius: 8px;
      transition: all 0.3s ease;
      align-self: flex-end; /* محاذاة إلى اليمين */
    }

    /* زر المحادثة الجديدة في الشريط الجانبي */
    .new-chat-btn {
      background: none;
      border: none;
      color: var(--theme-text-secondary);
      font-size: 2rem; /* زيادة حجم الأيقونة */
      cursor: pointer;
      padding: 12px;
      border-radius: 12px;
      transition: all 0.3s ease;
      align-self: flex-end; /* محاذاة إلى اليمين */
    }

    .new-chat-btn:hover {
      background: rgba(var(--theme-primary-rgb), 0.2);
      transform: scale(1.1);
    }

    .close-sidebar:hover {
      background: rgba(var(--theme-primary-rgb), 0.1);
      transform: scale(1.05);
    }

    /* قائمة الإعدادات داخل الشريط الجانبي */
    .settings-menu {
      width: 100%;
      background: var(--graphite);
      border: 1px solid rgba(var(--theme-primary-rgb), 0.3);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      z-index: 1001;
    }

    .settings-option {
      padding: 10px 15px;
      color: var(--theme-text-secondary);
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .settings-option:hover {
      background: rgba(var(--theme-primary-rgb), 0.2);
    }

    /* خيارات السمات */
    .theme-option.active {
      background: rgba(var(--theme-primary-rgb), 0.3);
      border-left: 3px solid var(--theme-primary);
    }

    .conversation-list {
      list-style: none;
    }

    .conversation-item {
      padding: 12px 15px;
      margin-bottom: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .conversation-item:hover {
      background: rgba(var(--theme-primary-rgb), 0.1);
      border-color: var(--theme-primary);
    }

    .conversation-title {
      font-size: 1rem;
      margin-bottom: 5px;
      color: var(--theme-text);
    }

    .conversation-preview {
      font-size: 0.85rem;
      color: #aaa;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .conversation-actions {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }

    .conv-btn {
      background: none;
      border: none;
      color: var(--theme-text-secondary);
      font-size: 0.9rem;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .conv-btn:hover {
      background: rgba(var(--theme-primary-rgb), 0.2);
    }

    /* التذييل بتصميم عصري */
    .app-footer {
      text-align: center;
      padding: 1.2rem;
      background: linear-gradient(90deg, var(--primary-black) 0%, var(--graphite) 100%);
      color: var(--theme-text-secondary);
      font-size: 0.95rem;
      border-top: 1px solid rgba(var(--theme-primary-rgb), 0.2);
    }

    /* نقاط التحميل */
    .loading-dots {
      display: flex;
      justify-content: center;
      padding: 15px;
    }

    .loading-dots span {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--theme-primary);
      margin: 0 5px;
      animation: bounce 1.4s infinite ease-in-out both;
    }

    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    /* تأثيرات متقدمة للشاشة */
    .particles {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    .particle {
      position: absolute;
      background: var(--theme-primary);
      border-radius: 50%;
      opacity: 0.2;
      animation: float 15s infinite linear;
    }

    @keyframes float {
      0% { transform: translateY(0) translateX(0); opacity: 0; }
      10% { opacity: 0.2; }
      100% { transform: translateY(-100vh) translateX(50px); opacity: 0; }
    }

    /* رسالة Toast */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      z-index: 9999;
      font-size: 0.95rem;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      border: 1px solid rgba(var(--theme-primary-rgb), 0.5);
    }

    .toast.show {
      opacity: 1;
    }

    /* نافذة الدعم */
    .support-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10001;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .support-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .support-content {
      background: var(--dark-charcoal);
      padding: 2rem;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      border: 2px solid var(--theme-primary);
      box-shadow: 0 0 30px rgba(var(--theme-primary-rgb), 0.3);
    }

    .support-title {
      text-align: center;
      color: var(--theme-primary);
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
    }

    .support-options {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-top: 1.5rem;
    }

    .support-option {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(var(--theme-primary-rgb), 0.3);
      transition: all 0.3s ease;
    }

    .support-option:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: var(--theme-primary);
      transform: translateY(-3px);
    }

    .option-title {
      color: var(--theme-primary);
      font-size: 1.2rem;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .option-description {
      color: var(--theme-text-secondary);
      font-size: 0.95rem;
      line-height: 1.6;
      margin-bottom: 15px;
    }

    .vodafone-number {
      background: rgba(var(--theme-primary-rgb), 0.1);
      padding: 12px 15px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 1.3rem;
      color: var(--theme-primary);
      text-align: center;
      margin: 10px 0;
      border: 1px dashed rgba(var(--theme-primary-rgb), 0.5);
    }

    .copy-btn {
      background: rgba(var(--theme-primary-rgb), 0.2);
      color: var(--theme-primary);
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 0.9rem;
      margin-top: 10px;
      width: 100%;
      transition: all 0.3s ease;
    }

    .copy-btn:hover {
      background: rgba(var(--theme-primary-rgb), 0.3);
      transform: translateY(-2px);
    }

    .video-option {
      background: rgba(76, 175, 80, 0.1);
      border-color: rgba(76, 175, 80, 0.3);
    }

    .video-option:hover {
      border-color: #4CAF50;
    }

    .video-option .option-title {
      color: #4CAF50;
    }

    .close-support {
      margin-top: 20px;
      width: 100%;
    }

    /* التصميم المتجاوب */
    @media (max-width: 768px) {
      .app-container {
        max-width: 100%;
      }
      
      .app-header {
        padding: 1rem;
        flex-direction: column;
        gap: 15px;
        position: relative;
      }
      
      /* نقل زر الهامبرجر إلى أعلى اليمين */
      .header-controls {
        order: -1;
        width: 100%;
        justify-content: flex-end;
        position: absolute;
        right: 12px;
        top: 12px;
      }
      
      .logo-main h1 {
        font-size: 2.2rem;
      }
      
      .main-logo {
        width: 100px;
        height: 100px;
      }
      
      .chat-container {
        padding: 1rem;
      }
      
      .chat-history {
        gap: 10px; /* تقليل المسافة أكثر على الموبايل */
        padding: 1rem;
        height: 60vh; /* تقليل الارتفاع على الشاشات الصغيرة */
      }
      
      .message {
        max-width: 95% !important;
        padding: 0.6rem !important;
        font-size: 1rem;
      }
      
      .user-message, .bot-message {
        max-width: 95% !important;
      }
      
      .message p {
        padding: 4px 8px; /* تقليل padding للنص على الموبايل */
      }
      
      .message-actions {
        gap: 6px; /* تقليل المسافة بين الأزرار */
      }
      
      .message-btn {
        width: 40px !important;
        height: 40px !important;
        min-width: 40px !important;
        font-size: 14px !important;
      }
      
      .send-fab {
        width: 50px;
        height: 50px;
        font-size: 1.3rem;
      }
      
      .attach-fab {
        width: 50px;
        height: 50px;
        font-size: 1.3rem;
        left: 68px;
      }
      
      textarea {
        padding-left: 8.5rem; /* زيادة المساحة للأزرار على الموبايل */
        min-height: 100px;
      }
      
      .sidebar {
        width: 280px;
      }
      
      /* تعديلات للشريط الجانبي على الشاشات الصغيرة */
      .sidebar-controls {
        gap: 12px;
      }
      
      .new-chat-btn {
        font-size: 1.8rem;
        padding: 10px;
      }
      
      .close-sidebar {
        font-size: 1.2rem;
        padding: 8px;
      }
      
      .login-btn {
        padding: 6px 12px;
        font-size: 0.9rem;
      }
      
      .user-name {
        max-width: 80px;
      }
      
      .support-content {
        padding: 1.5rem;
      }
      
      .vodafone-number {
        font-size: 1.1rem;
        padding: 10px;
      }
    }

    /* تصميم خاص للشاشات الصغيرة جداً */
    @media (max-width: 360px) {
      .message-actions {
        gap: 4px;
      }
      
      .message-btn {
        width: 36px !important;
        height: 36px !important;
        min-width: 36px !important;
        font-size: 13px !important;
      }
      
      .login-btn {
        padding: 4px 8px;
        font-size: 0.8rem;
      }
    }

    /* إضافة aria-live للوصولية */
    .chat-history {
      aria-live: polite;
    }
  </style>
</head>
<body>
  <!-- جسيمات متحركة للخلفية -->
  <div class="particles" id="particles"></div>
  
  <!-- رسالة Toast -->
  <div class="toast" id="toast"></div>
  
  <!-- نافذة الدعم -->
  <div class="support-modal" id="supportModal">
    <div class="support-content">
      <h3 class="support-title">ادعم سعد.AI</h3>
      <p style="text-align: center; color: var(--theme-text-secondary); margin-bottom: 1.5rem;">
        دعمك يساعدنا على الاستمرار والتطوير. اختر طريقة الدعم المناسبة لك:
      </p>
      
      <div class="support-options">
        <div class="support-option">
          <div class="option-title">
            <i class="fas fa-mobile-alt"></i>
            <span>فودافون كاش (للمستخدمين في مصر)</span>
          </div>
          <div class="option-description">
            يمكنك الدعم المادي عن طريق تحويل أي مبلغ عبر فودافون كاش إلى الرقم التالي:
          </div>
          <div class="vodafone-number" id="vodafoneNumber">01030787655</div>
          <button class="copy-btn" id="copyVodafoneBtn">
            <i class="fas fa-copy"></i>
            نسخ الرقم
          </button>
        </div>
        
        <div class="support-option video-option">
          <div class="option-title">
            <i class="fas fa-video"></i>
            <span>إنشاء فيديو ترويجي</span>
          </div>
          <div class="option-description">
            إذا كنت لا تستطيع الدعم مادياً، يمكنك مساعدتنا عن طريق إنشاء فيديو تتحدث فيه عن سعد.AI وتجربتك معه، ثم نشره على منصات التواصل الاجتماعي مع وضع رابط الموقع.
          </div>
          <div class="option-description" style="color: #4CAF50; font-weight: bold;">
            هذا الدعم غير المادي له قيمة كبيرة بالنسبة لنا ويساعد في انتشار التطبيق!
          </div>
        </div>
      </div>
      
      <button class="secondary-btn close-support" id="closeSupportBtn">
        <i class="fas fa-times"></i>
        إغلاق
      </button>
    </div>
  </div>
  
  <!-- إدخال ملف مخفي -->
  <input type="file" id="fileInput" accept=".txt,.py,.js,.ts,.json,.html,.css,.md,.xml" hidden>
  
  <!-- الشريط الجانبي المعدل -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h3 class="sidebar-title">المحادثات والإعدادات</h3>
      <div class="sidebar-controls">
        <button class="new-chat-btn" id="newChatBtn" title="بدء محادثة جديدة">
          <i class="fas fa-plus"></i>
        </button>
        <button class="close-sidebar" id="closeSidebar">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <!-- قائمة الإعدادات داخل الشريط الجانبي -->
    <div class="settings-menu" id="settingsMenu">
      <div class="settings-option" id="exportChat">
        <i class="fas fa-download"></i> تصدير المحادثة الحالية
      </div>
      <div class="settings-option" id="importChat">
        <i class="fas fa-upload"></i> استيراد محادثة
      </div>
      <div class="settings-option" id="resetSettings">
        <i class="fas fa-redo"></i> إعادة تعيين الإعدادات
      </div>
      <div class="settings-option" id="clearChat">
        <i class="fas fa-trash-alt"></i> مسح المحادثة الحالية
      </div>
      
      <!-- خيارات السمات -->
      <div class="settings-option theme-option active" data-theme="dark" id="themeDark">
        <i class="fas fa-moon"></i> السمة الداكنة
      </div>
      <div class="settings-option theme-option" data-theme="light" id="themeLight">
        <i class="fas fa-sun"></i> السمة الفاتحة
      </div>
      <div class="settings-option theme-option" data-theme="blue" id="themeBlue">
        <i class="fas fa-palette"></i> السمة الزرقاء
      </div>
      <div class="settings-option theme-option" data-theme="green" id="themeGreen">
        <i class="fas fa-leaf"></i> السمة الخضراء
      </div>
      
      <!-- زر الدعم -->
      <div class="settings-option" id="supportBtn">
        <i class="fas fa-heart" style="color: #ff4757;"></i> ادعمنا
      </div>
    </div>

    <!-- قائمة المحادثات -->
    <ul class="conversation-list" id="conversationList">
      <!-- سيتم ملؤها بالجافاسكريبت -->
    </ul>
  </div>
  
  <div class="app-container">
    <div class="app-header">
      <div class="header-controls">
        <!-- زر القائمة (هامبرغر) -->
        <button class="header-btn" id="sidebarToggle">
          <i class="fas fa-bars"></i>
        </button>
      </div>
      <div class="logo-main">
        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='none' stroke='%234895ef' stroke-width='3'/><path d='M30,30 L50,70 L70,30' fill='none' stroke='%234895ef' stroke-width='3' stroke-linecap='round'/><circle cx='50' cy='40' r='5' fill='%234895ef'/></svg>" alt="Saad.AI Logo" class="main-logo">
        <h1>Saad.AI</h1>
      </div>
      <div class="subtitle">نظام ذكاء اصطناعي متطور ذاتي التعلم والتكيف، صمم خصيصاً لتقديم حلول ذكية وإبداعية في كل المجالات</div>
    </div>

    <div class="chat-container">
      <div class="chat-history" id="chatHistory">
        <div class="welcome-message">
          <p>مرحباً! أنا سعد.AI، رفيقك الذكي في العالم الرقمي. كيف يمكنني مساعدتك اليوم؟</p>
        </div>
      </div>

      <div class="input-area">
        <textarea id="userInput" placeholder="اكتب رسالتك هنا... (Shift+Enter للسطر الجديد)"></textarea>
        <button class="attach-fab" id="attachButton" title="رفع ملف نصي" aria-label="رفع ملف">
          <i class="fas fa-paperclip"></i>
        </button>
        <button class="send-fab" id="sendButton" title="إرسال الرسالة" aria-label="إرسال الرسالة">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>

    <div class="app-footer">
      <p>الإصدار الخارق (Saad01 Ultimate Edition) &copy; 2025 - جميع الحقوق محفوظة</p>
    </div>
  </div>
  
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // الحصول على العناصر
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const attachButton = document.getElementById('attachButton');
    const fileInput = document.getElementById('fileInput');
    const chatHistory = document.getElementById('chatHistory');
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const closeSidebar = document.getElementById('closeSidebar');
    const newChatBtn = document.getElementById('newChatBtn');
    const settingsMenu = document.getElementById('settingsMenu');
    const conversationList = document.getElementById('conversationList');
    const toast = document.getElementById('toast');
    
    // عناصر الدعم الجديدة
    const supportBtn = document.getElementById('supportBtn');
    const supportModal = document.getElementById('supportModal');
    const closeSupportBtn = document.getElementById('closeSupportBtn');
    const copyVodafoneBtn = document.getElementById('copyVodafoneBtn');
    const vodafoneNumber = document.getElementById('vodafoneNumber');
    
    // العناصر الخاصة بالسمات
    const themeOptions = document.querySelectorAll('.theme-option');
    const themeDark = document.getElementById('themeDark');
    const themeLight = document.getElementById('themeLight');
    const themeBlue = document.getElementById('themeBlue');
    const themeGreen = document.getElementById('themeGreen');
    
    // تخزين المحادثات
    let conversations = [];
    let currentConversationId = 'default';
    let conversationTitleGenerated = false;
    let currentTheme = localStorage.getItem('saadai_theme') || 'dark';
    
    // تطبيق السمة الحالية
    applyTheme(currentTheme);
    updateThemeButtons();
    
    // تحميل محادثات المستخدم
    loadUserConversations();
    
    // إنشاء جسيمات الخلفية
    function createParticles() {
      const particlesContainer = document.getElementById('particles');
      const particleCount = 30;

      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.classList.add('particle');
        const size = Math.random() * 5 + 1;
        const posX = Math.random() * 100;
        const duration = Math.random() * 20 + 10;
        const delay = Math.random() * 5;
        const color = `hsl(${Math.random() * 360}, 70%, 60%)`;

        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.left = `${posX}%`;
        particle.style.background = color;
        particle.style.animationDuration = `${duration}s`;
        particle.style.animationDelay = `${delay}s`;

        particlesContainer.appendChild(particle);
      }
    }
    
    // عرض رسالة Toast
    function showToast(message, duration = 2000) {
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }
    
    // تطبيق السمة
    function applyTheme(theme) {
      document.body.classList.remove('theme-light', 'theme-blue', 'theme-green');
      if (theme !== 'dark') {
        document.body.classList.add(`theme-${theme}`);
      }
      
      // تحديث CSS Variables لتحويل الألوان إلى RGB
      updateCSSVariables();
      
      localStorage.setItem('saadai_theme', theme);
      currentTheme = theme;
    }
    
    // تحديث CSS Variables لتحويل الألوان إلى RGB
    function updateCSSVariables() {
      const root = document.documentElement;
      const primaryColor = getComputedStyle(root).getPropertyValue('--theme-primary').trim();
      const secondaryColor = getComputedStyle(root).getPropertyValue('--theme-secondary').trim();
      
      // تحويل الألوان إلى RGB
      function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
          r: parseInt(result[1], 16),
          g: parseInt(result[2], 16),
          b: parseInt(result[3], 16)
        } : null;
      }
      
      const primaryRGB = hexToRgb(primaryColor);
      const secondaryRGB = hexToRgb(secondaryColor);
      
      if (primaryRGB) {
        root.style.setProperty('--theme-primary-rgb', `${primaryRGB.r}, ${primaryRGB.g}, ${primaryRGB.b}`);
      }
      
      if (secondaryRGB) {
        root.style.setProperty('--theme-secondary-rgb', `${secondaryRGB.r}, ${secondaryRGB.g}, ${secondaryRGB.b}`);
      }
    }
    
    // تحديث أزرار السمات
    function updateThemeButtons() {
      themeOptions.forEach(option => {
        option.classList.remove('active');
        if (option.dataset.theme === currentTheme) {
          option.classList.add('active');
        }
      });
    }
    
    // تحميل محادثات المستخدم
    function loadUserConversations() {
      conversations = JSON.parse(localStorage.getItem('saadai_conversations')) || [];
      updateConversationList();
    }
    
    // حفظ محادثات المستخدم
    function saveConversations() {
      localStorage.setItem('saadai_conversations', JSON.stringify(conversations));
    }
    
    // تهيئة الجسيمات
    createParticles();
    updateCSSVariables(); // تحديث CSS Variables عند التحميل
    
    // تحديث قائمة المحادثات
    function updateConversationList() {
      conversationList.innerHTML = '';
      
      if (conversations.length === 0) {
        conversationList.innerHTML = '<p style="color: #777; text-align: center;">لا توجد محادثات سابقة</p>';
        return;
      }
      
      conversations.forEach((conv, index) => {
        const li = document.createElement('li');
        li.className = 'conversation-item';
        li.dataset.id = conv.id;
        
        const title = conv.title || `محادثة ${index + 1}`;
        const preview = conv.messages && conv.messages.length > 0 
          ? conv.messages[0].text.substring(0, 50) + '...'
          : 'لا توجد رسائل';
        
        li.innerHTML = `
          <div class="conversation-title">${title}</div>
          <div class="conversation-preview">${preview}</div>
          <div class="conversation-actions">
            <button class="conv-btn edit-conv" title="تعديل العنوان"><i class="fas fa-edit"></i></button>
            <button class="conv-btn delete-conv" title="حذف المحادثة"><i class="fas fa-trash"></i></button>
          </div>
        `;
        
        // حدث فتح المحادثة
        li.querySelector('.conversation-title').addEventListener('click', () => {
          loadConversation(conv.id);
          sidebar.classList.remove('open');
        });
        
        // حدث تعديل العنوان
        li.querySelector('.edit-conv').addEventListener('click', (e) => {
          e.stopPropagation();
          const newTitle = prompt('أدخل العنوان الجديد:', title);
          if (newTitle && newTitle.trim()) {
            conv.title = newTitle.trim();
            saveConversations();
            updateConversationList();
          }
        });
        
        // حدث حذف المحادثة
        li.querySelector('.delete-conv').addEventListener('click', (e) => {
          e.stopPropagation();
          if (confirm('هل أنت متأكد من حذف هذه المحادثة؟')) {
            conversations = conversations.filter(c => c.id !== conv.id);
            saveConversations();
            updateConversationList();
          }
        });
        
        conversationList.appendChild(li);
      });
    }
    
    // تحميل محادثة
    function loadConversation(id) {
      const conv = conversations.find(c => c.id === id);
      if (!conv) return;
      
      chatHistory.innerHTML = '<div class="welcome-message"><p>تحميل المحادثة...</p></div>';
      
      setTimeout(() => {
        chatHistory.innerHTML = '';
        conv.messages.forEach(msg => {
          addMessage(msg.text, msg.sender, false, msg.id);
        });
        currentConversationId = id;
        conversationTitleGenerated = true;
      }, 300);
    }
    
    // حفظ الرسالة في المحادثة الحالية
    function saveMessage(text, sender, messageId, conversationTitle = null) {
      let conv = conversations.find(c => c.id === currentConversationId);
      
      if (!conv) {
        conv = {
          id: currentConversationId,
          title: conversationTitle || text.substring(0, 20) + '...',
          messages: [],
          created: new Date().toISOString()
        };
        conversations.push(conv);
      }
      
      conv.messages.push({
        id: messageId || Date.now().toString(),
        text: text,
        sender: sender,
        timestamp: new Date().toISOString()
      });
      
      if (conversationTitle && !conv.title) {
        conv.title = conversationTitle;
      }
      
      saveConversations();
      updateConversationList();
    }
    
    // اقتراح عنوان للمحادثة
    async function suggestConversationTitle(userMessage, aiResponse) {
      try {
        const response = await fetch('/api/suggest_title', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            user_message: userMessage,
            ai_response: aiResponse
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        return data.title;
      } catch (error) {
        console.error('Error suggesting title:', error);
        return null;
      }
    }
    
    // إرسال بالضغط على إنتر
    userInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    // حدث إرسال الرسالة
    sendButton.addEventListener('click', sendMessage);
    
    // حدث رفع الملف
    attachButton.addEventListener('click', () => {
      fileInput.click();
    });
    
    fileInput.addEventListener('change', handleFileUpload);
    
    async function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // التحقق من نوع الملف
      const allowedExtensions = ['.txt', '.py', '.js', '.ts', '.json', '.html', '.css', '.md', '.xml'];
      const fileExt = '.' + file.name.split('.').pop().toLowerCase();
      if (!allowedExtensions.includes(fileExt)) {
        showToast('نوع الملف غير مسموح به. يسمح فقط بالملفات النصية والبرمجية.', 3000);
        fileInput.value = '';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const fileContent = e.target.result;
        const messageId = Date.now().toString();
        const fileName = file.name;
        const messageText = `[ملف مرفق: ${fileName}]\n\n${fileContent}`;
        
        addMessage(messageText, 'user', true, messageId);
        saveMessage(messageText, 'user', messageId);
        
        // إرسال محتوى الملف إلى الخادم
        sendFileContent(messageText);
      };
      reader.readAsText(file);
      
      // إعادة تعيين قيمة الإدخال للسماح برفع نفس الملف مرة أخرى إذا لزم الأمر
      fileInput.value = '';
    }
    
    async function sendFileContent(content) {
      const loadingId = showLoading();
      
      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            "رسالة": content,
            "معرف_المستخدم": 'guest_user',
            "نوع": "ملف"
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        let botResponse = '';
        
        if (data.رد) {
          botResponse = data.رد;
          addMessage(botResponse, 'bot', true);
          saveMessage(botResponse, 'bot');
        } else if (data.responses) {
          const responses = [
            `[تقني] ${data.responses.technical || 'لا يوجد رد تقني'}`,
            `[عملي] ${data.responses.practical || 'لا يوجد رد عملي'}`,
            `[إبداعي] ${data.responses.creative || 'لا يوجد رد إبداعي'}`
          ];
          botResponse = responses.join('\n');
          responses.forEach(response => {
            addMessage(response, 'bot', true);
            saveMessage(response, 'bot');
          });
        } else {
          botResponse = 'تلقيت ردًا غير متوقع من الخادم';
          addMessage(botResponse, 'bot', true);
          saveMessage(botResponse, 'bot');
        }
        
        // اقتراح عنوان للمحادثة إذا كانت هذه أول رسالة للمستخدم في المحادثة الحالية
        if (!conversationTitleGenerated) {
          const conv = conversations.find(c => c.id === currentConversationId);
          if (conv && conv.messages && conv.messages.filter(m => m.sender === 'user').length === 1) {
            const suggestedTitle = await suggestConversationTitle(content, botResponse);
            if (suggestedTitle) {
              conv.title = suggestedTitle;
              saveConversations();
              updateConversationList();
            }
            conversationTitleGenerated = true;
          }
        }
      } catch (error) {
        console.error('Error:', error);
        addMessage(`حدث خطأ أثناء معالجة الملف: ${error.message}`, 'bot', true);
        saveMessage(`حدث خطأ أثناء معالجة الملف: ${error.message}`, 'bot');
      } finally {
        removeLoading(loadingId);
      }
    }
    
    // تبديل الشريط الجانبي (يظهر قائمة المحادثات والإعدادات معاً)
    sidebarToggle.addEventListener('click', () => {
      sidebar.classList.toggle('open');
    });
    
    closeSidebar.addEventListener('click', () => {
      sidebar.classList.remove('open');
    });
    
    // أحداث السمات
    themeOptions.forEach(option => {
      option.addEventListener('click', () => {
        const theme = option.dataset.theme;
        applyTheme(theme);
        updateThemeButtons();
        showToast(`تم تطبيق السمة: ${option.textContent.trim()}`);
      });
    });
    
    // بدء محادثة جديدة
    newChatBtn.addEventListener('click', () => {
      currentConversationId = 'default_' + Date.now();
      conversationTitleGenerated = false;
      
      chatHistory.innerHTML = `
        <div class="welcome-message">
          <p>مرحباً! أنا سعد.AI، رفيقك الذكي في العالم الرقمي. كيف يمكنني مساعدتك اليوم؟</p>
        </div>
      `;
      
      userInput.value = '';
      userInput.focus();
      sidebar.classList.remove('open');
      showToast('تم بدء محادثة جديدة');
    });
    
    // تصدير المحادثة الحالية
    document.getElementById('exportChat').addEventListener('click', () => {
      const messages = Array.from(document.querySelectorAll('.message')).map(msg => ({
        sender: msg.classList.contains('user-message') ? 'user' : 'bot',
        text: msg.querySelector('p').textContent,
        time: msg.querySelector('.message-time').textContent
      }));
      
      const dataStr = JSON.stringify(messages, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileDefaultName = `saadai_chat_${new Date().toISOString().split('T')[0]}.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
      
      showToast('تم تصدير المحادثة بنجاح');
    });
    
    // استيراد محادثة
    document.getElementById('importChat').addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      
      input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        
        reader.onload = function(event) {
          try {
            const messages = JSON.parse(event.target.result);
            chatHistory.innerHTML = '';
            
            messages.forEach(msg => {
              addMessage(msg.text, msg.sender);
            });
            
            showToast('تم استيراد المحادثة بنجاح');
          } catch (error) {
            alert('خطأ في تنسيق الملف');
          }
        };
        
        reader.readAsText(file);
      };
      
      input.click();
    });
    
    // إعادة تعيين الإعدادات
    document.getElementById('resetSettings').addEventListener('click', () => {
      if (confirm('هل تريد حقاً إعادة تعيين جميع الإعدادات والمحادثات؟')) {
        localStorage.removeItem('saadai_conversations');
        conversations = [];
        updateConversationList();
        applyTheme('dark');
        updateThemeButtons();
        showToast('تم إعادة تعيين الإعدادات');
      }
    });
    
    // مسح المحادثة الحالية
    document.getElementById('clearChat').addEventListener('click', clearCurrentConversation);
    
    function clearCurrentConversation() {
      if (confirm('هل أنت متأكد من مسح كامل المحادثة الحالية؟')) {
        chatHistory.innerHTML = `
          <div class="welcome-message">
            <p>مرحباً! أنا سعد.AI، رفيقك الذكي في العالم الرقمي. كيف يمكنني مساعدتك اليوم؟</p>
          </div>
        `;
        currentConversationId = 'default_' + Date.now();
        conversationTitleGenerated = false;
        showToast('تم مسح المحادثة الحالية');
      }
    }
    
    // أحداث الدعم
    supportBtn.addEventListener('click', () => {
      supportModal.classList.add('active');
      sidebar.classList.remove('open');
    });
    
    closeSupportBtn.addEventListener('click', () => {
      supportModal.classList.remove('active');
    });
    
    copyVodafoneBtn.addEventListener('click', () => {
      const number = vodafoneNumber.textContent;
      copyToClipboard(number);
      showToast('تم نسخ رقم فودافون كاش: ' + number);
    });
    
    // التعامل مع أحداث الأزرار باستخدام الـ delegation
    chatHistory.addEventListener('click', function(e) {
      const btn = e.target.closest('.message-btn');
      if (!btn) return;
      
      const message = btn.closest('.message');
      const text = message.querySelector('p')?.textContent?.trim() || '';
      const messageId = message.dataset.messageId || Date.now().toString();
      
      if (btn.classList.contains('copy-btn')) {
        // نسخ النص
        copyToClipboard(text);
      } else if (btn.classList.contains('edit-btn')) {
        // تعديل السؤال - فقط لرسائل المستخدم
        if (message.classList.contains('user-message')) {
          userInput.value = text;
          userInput.focus();
          
          // إزالة الرسالة الحالية والرد التالي لها (إن وجد)
          message.remove();
          const nextMessage = message.nextElementSibling;
          if (nextMessage && nextMessage.classList.contains('bot-message')) {
            nextMessage.remove();
          }
        }
      } else if (btn.classList.contains('regenerate-btn')) {
        // إعادة توليد الرد - فقط لرسائل البوت
        if (message.classList.contains('bot-message')) {
          const previousUserMessage = message.previousElementSibling;
          if (previousUserMessage && previousUserMessage.classList.contains('user-message')) {
            const userText = previousUserMessage.querySelector('p').textContent;
            message.remove();
            
            // إرسال الرسالة مرة أخرى لتوليد رد جديد
            userInput.value = userText;
            sendMessage();
          }
        }
      } else if (btn.classList.contains('like-btn')) {
        // إعجاب
        btn.classList.toggle('active-like');
        btn.closest('.message-actions').querySelector('.dislike-btn').classList.remove('active-dislike');
        
        sendFeedback(messageId, 'like', text);
        btn.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
          btn.innerHTML = '<i class="fas fa-thumbs-up"></i>';
        }, 2000);
      } else if (btn.classList.contains('dislike-btn')) {
        // عدم إعجاب
        btn.classList.toggle('active-dislike');
        btn.closest('.message-actions').querySelector('.like-btn').classList.remove('active-like');
        
        sendFeedback(messageId, 'dislike', text);
        btn.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
          btn.innerHTML = '<i class="fas fa-thumbs-down"></i>';
        }, 2000);
      }
    });
    
    // نسخ النص إلى الحافظة مع fallback
    function copyToClipboard(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(() => showToast('تم نسخ النص إلى الحافظة'))
          .catch(err => {
            console.error('Failed to copy: ', err);
            fallbackCopyText(text);
          });
      } else {
        fallbackCopyText(text);
      }
    }
    
    // طريقة بديلة للنسخ
    function fallbackCopyText(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.opacity = '0';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          showToast('تم نسخ النص إلى الحافظة');
        } else {
          showToast('فشل نسخ النص', 3000);
        }
      } catch (err) {
        console.error('Fallback copy failed: ', err);
        showToast('فشل نسخ النص', 3000);
      }
      
      document.body.removeChild(textArea);
    }
    
    // إرسال التقييم للخادم
    async function sendFeedback(messageId, feedback, text) {
      try {
        await fetch('/api/feedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messageId: messageId,
            feedback: feedback,
            text: text,
            userId: 'guest'
          })
        });
      } catch (error) {
        console.error('Feedback error:', error);
      }
    }
    
    // إرسال رسالة للخادم
    async function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;
      
      const messageId = Date.now().toString();
      addMessage(message, 'user', true, messageId);
      saveMessage(message, 'user', messageId);
      userInput.value = '';
      
      const loadingId = showLoading();
      
      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            "رسالة": message,
            "معرف_المستخدم": 'guest_user'
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        let botResponse = '';
        
        if (data.رد) {
          botResponse = data.رد;
          addMessage(botResponse, 'bot', true);
          saveMessage(botResponse, 'bot');
        } else if (data.responses) {
          const responses = [
            `[تقني] ${data.responses.technical || 'لا يوجد رد تقني'}`,
            `[عملي] ${data.responses.practical || 'لا يوجد رد عملي'}`,
            `[إبداعي] ${data.responses.creative || 'لا يوجد رد إبداعي'}`
          ];
          botResponse = responses.join('\n');
          responses.forEach(response => {
            addMessage(response, 'bot', true);
            saveMessage(response, 'bot');
          });
        } else {
          botResponse = 'تلقيت ردًا غير متوقع من الخادم';
          addMessage(botResponse, 'bot', true);
          saveMessage(botResponse, 'bot');
        }
        
        // اقتراح عنوان للمحادثة إذا كانت هذه أول رسالة للمستخدم في المحادثة الحالية
        if (!conversationTitleGenerated) {
          const conv = conversations.find(c => c.id === currentConversationId);
          if (conv && conv.messages && conv.messages.filter(m => m.sender === 'user').length === 1) {
            const suggestedTitle = await suggestConversationTitle(message, botResponse);
            if (suggestedTitle) {
              conv.title = suggestedTitle;
              saveConversations();
              updateConversationList();
            }
            conversationTitleGenerated = true;
          }
        }
      } catch (error) {
        console.error('Error:', error);
        addMessage(`حدث خطأ: ${error.message}`, 'bot', true);
        saveMessage(`حدث خطأ: ${error.message}`, 'bot');
      } finally {
        removeLoading(loadingId);
      }
    }
    
    // إضافة رسالة للشاشة مع أزرار
    function addMessage(text, sender, withActions = true, messageId = null) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message', `${sender}-message`);
      messageDiv.setAttribute('role', 'article');
      messageDiv.setAttribute('aria-label', `${sender === 'user' ? 'رسالة المستخدم' : 'رد الذكاء الاصطناعي'}: ${text.substring(0, 50)}...`);
      
      if (messageId) {
        messageDiv.dataset.messageId = messageId;
      }
      
      const now = new Date();
      const timeString = now.toLocaleTimeString('ar-EG', {
        hour: '2-digit',
        minute: '2-digit'
      });
      
      messageDiv.innerHTML = `
        <p>${text}</p>
        <span class="message-time">${timeString}</span>
      `;
      
      // إضافة أزرار خاصة لكل نوع من الرسائل
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'message-actions';
      
      if (sender === 'user') {
        // أزرار رسائل المستخدم: نسخ وتعديل
        actionsDiv.innerHTML = `
          <button class="message-btn copy-btn" title="نسخ الرسالة" aria-label="نسخ النص">
            <i class="fas fa-copy"></i>
          </button>
          <button class="message-btn edit-btn" title="تعديل الرسالة" aria-label="تعديل الرسالة">
            <i class="fas fa-pencil-alt"></i>
          </button>
        `;
      } else if (sender === 'bot' && withActions) {
        // أزرار رسائل البوت: نسخ، إعادة توليد، إعجاب، عدم إعجاب
        actionsDiv.innerHTML = `
          <button class="message-btn copy-btn" title="نسخ الرد" aria-label="نسخ النص">
            <i class="fas fa-copy"></i>
          </button>
          <button class="message-btn regenerate-btn" title="إعادة توليد الرد" aria-label="إعادة توليد الرد">
            <i class="fas fa-redo"></i>
          </button>
          <button class="message-btn like-btn" title="إعجاب (للمساعدة في التعلم)" aria-label="إعجاب بالرد">
            <i class="fas fa-thumbs-up"></i>
          </button>
          <button class="message-btn dislike-btn" title="عدم إعجاب (للمساعدة في التعلم)" aria-label="عدم إعجاب بالرد">
            <i class="fas fa-thumbs-down"></i>
          </button>
        `;
      }
      
      if (actionsDiv.innerHTML.trim() !== '') {
        messageDiv.appendChild(actionsDiv);
      }
      
      chatHistory.appendChild(messageDiv);
      chatHistory.scrollTop = chatHistory.scrollHeight;
      
      // تأثير الظهور
      messageDiv.style.transform = 'scale(0.9)';
      messageDiv.style.opacity = '0';
      setTimeout(() => {
        messageDiv.style.transform = 'scale(1)';
        messageDiv.style.opacity = '1';
      }, 10);
    }
    
    // عرض مؤشر التحميل
    function showLoading() {
      const loadingId = 'loading-' + Date.now();
      const loadingDiv = document.createElement('div');
      loadingDiv.id = loadingId;
      loadingDiv.classList.add('message', 'bot-message');
      loadingDiv.innerHTML = `
        <div class="loading-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
      `;
      chatHistory.appendChild(loadingDiv);
      chatHistory.scrollTop = chatHistory.scrollHeight;
      return loadingId;
    }
    
    // إزالة مؤشر التحميل
    function removeLoading(id) {
      const loadingElement = document.getElementById(id);
      if (loadingElement) {
        loadingElement.style.opacity = '0';
        setTimeout(() => {
          if (loadingElement.parentNode) {
            loadingElement.parentNode.removeChild(loadingElement);
          }
        }, 300);
      }
    }
    
    // تهيئة قائمة المحادثات
    updateConversationList();
  });
  </script>
</body>
</html>
